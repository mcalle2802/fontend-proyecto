---
import BaseLayout from "../layouts/BaseLayout.astro";
---
<BaseLayout title="Access to Juan Sao Ville's Domain">
  <section
    style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      color: #f8e3c8;
    "
  >
    <div
      style="
        background: rgba(25, 15, 40, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 150, 50, 0.2);
        box-shadow: 0 0 30px rgba(255, 120, 0, 0.2);
        padding: 3rem 2rem;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        text-align: center;
      "
    >
      <h2
        style="
          color: #ffb366;
          text-shadow: 0 0 12px rgba(255, 180, 80, 0.6);
          margin-bottom: 1.5rem;
        "
      >
        üîí Sign In
      </h2>

      <!-- Error message container -->
      <div
        id="errorMessage"
        style="
          display: none;
          background: rgba(255, 68, 68, 0.1);
          border: 1px solid rgba(255, 68, 68, 0.4);
          color: #ff6666;
          padding: 0.8rem;
          border-radius: 8px;
          margin-bottom: 1rem;
          font-size: 0.9rem;
        "
      ></div>

      <form id="loginForm" style="display: flex; flex-direction: column; gap: 1rem;">
        <input
          type="email"
          name="email"
          id="email"
          placeholder="Email address"
          required
          style="
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,180,80,0.3);
            padding: 0.8rem;
            color: #fff;
            border-radius: 8px;
            outline: none;
          "
        />
        <input
          type="password"
          name="password"
          id="password"
          placeholder="Password"
          required
          style="
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,180,80,0.3);
            padding: 0.8rem;
            color: #fff;
            border-radius: 8px;
            outline: none;
          "
        />
        <button
          type="submit"
          id="submitBtn"
          style="
            background: linear-gradient(90deg, #ff7b00, #ffb366);
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            color: #1b0f1f;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
          "
        >
          <span id="btnText">Enter</span>
          <span id="btnLoader" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 1s linear infinite;">
              <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="0.75"/>
            </svg>
          </span>
        </button>
      </form>
    </div>
  </section>
</BaseLayout>

<style>
  button:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 150, 50, 0.8);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  input:focus {
    border-color: #ffb366;
    box-shadow: 0 0 8px rgba(255, 180, 80, 0.6);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  const API_URL = "http://localhost:3000/auth/login";

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(
        atob(base64)
          .split('')
          .map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
          })
          .join('')
      );
      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error('Error parsing JWT:', e);
      return null;
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById("errorMessage");
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.style.display = "block";
    }
  }

  function hideError() {
    const errorDiv = document.getElementById("errorMessage");
    if (errorDiv) {
      errorDiv.style.display = "none";
    }
  }

  function setLoading(loading) {
    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const btnLoader = document.getElementById("btnLoader");

    if (submitBtn) submitBtn.disabled = loading;
    if (btnText) btnText.style.display = loading ? "none" : "inline";
    if (btnLoader) btnLoader.style.display = loading ? "inline" : "none";
  }

  // Normalizar extracci√≥n de rol (maneja string, array, o ubicaciones en response)
  function resolveRoleFromResponse(data, payload) {
    // 1) intentar extraer rol directamente desde la respuesta del API
    const apiPaths = [
      () => (data && data.role),
      () => (data && data.roles),
      () => (data && data.data && data.data.role),
      () => (data && data.data && data.data.roles),
      () => (data && data.user && data.user.role),
      () => (data && data.user && data.user.roles),
      () => (data && data.data && data.data.user && data.data.user.role),
      () => (data && data.data && data.data.user && data.data.user.roles)
    ];

    for (const get of apiPaths) {
      const v = get();
      if (v) {
        if (Array.isArray(v) && v.length) return String(v[0]);
        if (typeof v === 'string') return v;
      }
    }

    // 2) si no hay en la respuesta, intentar del payload del token
    if (payload) {
      const p = payload.roles ?? payload.role ?? payload.user?.roles ?? payload.user?.role;
      if (Array.isArray(p) && p.length) return String(p[0]);
      if (typeof p === 'string') return p;
    }

    // 3) fallback
    return 'user';
  }

  document.addEventListener("DOMContentLoaded", function () {
    const loginForm = document.getElementById("loginForm");
    if (!loginForm) return;

    loginForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      hideError();
      setLoading(true);

      const formData = new FormData(loginForm);
      const email = formData.get("email");
      const password = formData.get("password");

      console.log("FORM SUBMIT ATTEMPT:", { email, passwordPresent: !!password });

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ email, password })
        });

        console.log("DEBUG response status:", res.status);
        for (const [k, v] of res.headers.entries()) console.log("DEBUG header:", k, v);

        // Leer texto crudo y parsear de forma segura
        const rawText = await res.text();
        let data = null;
        try { data = rawText ? JSON.parse(rawText) : null; } catch (err) {
          console.warn("Failed to parse JSON response:", err, "raw:", rawText);
        }
        console.log("DEBUG parsed response object:", data);

        if (!res.ok) {
          if (res.status === 401) {
            showError("‚ùå Invalid credentials. Please check and try again.");
          } else if (res.status === 404) {
            showError("‚ùå Email not found. Please verify your email or register.");
          } else if (res.status === 400) {
            showError("‚ùå Please provide both email and password.");
          } else {
            showError((data && (data.message || data.error)) || "‚ùå Login failed. Please try again.");
          }
          setLoading(false);
          return;
        }

        // Identificar token y user seg√∫n la forma de tu API
        const token =
          (data && (data.token || data.data?.token || data.data?.data?.token)) ||
          null;

        const userObj =
          (data && (data.user || data.data?.user || data.data?.data?.user)) ||
          null;

        console.log("DEBUG user object from response:", userObj);
        console.log("DEBUG token from response:", token);

        const payload = token ? parseJwt(token) : null;
        console.log("DEBUG jwt payload:", payload);

        // Resolver rol y normalizar
        const userRole = resolveRoleFromResponse(data, payload);
        console.log("Resolved userRole:", userRole);

        // Guardar info para UI (no almacenar secretos)
        if (token) localStorage.setItem("token", token);
        if (userObj && userObj.email) localStorage.setItem("userEmail", userObj.email);
        localStorage.setItem("userRole", userRole);
        localStorage.setItem("userName", (userObj && (userObj.name || userObj.username)) || payload?.name || "User");

        // Redirigir seg√∫n rol (ajusta si tu backend usa otros nombres)
        if (['master'].includes(userRole)) {
          window.location.href = '/admin';
        } else if (['slave'].includes(userRole)) {
          window.location.href = '/slave';
        } else if (['developer'].includes(userRole)) {
          window.location.href = '/developer';
        } else {
          window.location.href = '/';
        }

      } catch (error) {
        console.error("Login error:", error);
        showError("‚ùå Connection error. Please check your network and try again.");
        setLoading(false);
      }
    });
  });
</script>