---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Access to Juan Sao Ville's Domain">
  <section
    style="
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      color: #f8e3c8;
    "
  >
    <div
      style="
        background: rgba(25, 15, 40, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 150, 50, 0.2);
        box-shadow: 0 0 30px rgba(255, 120, 0, 0.2);
        padding: 3rem 2rem;
        border-radius: 12px;
        max-width: 400px;
        width: 90%;
        text-align: center;
      "
    >
      <h2
        style="
          color: #ffb366;
          text-shadow: 0 0 12px rgba(255, 180, 80, 0.6);
          margin-bottom: 1.5rem;
        "
      >
        üîí Sign In
      </h2>

      <!-- Error message container -->
      <div
        id="errorMessage"
        style="
          display: none;
          background: rgba(255, 68, 68, 0.1);
          border: 1px solid rgba(255, 68, 68, 0.4);
          color: #ff6666;
          padding: 0.8rem;
          border-radius: 8px;
          margin-bottom: 1rem;
          font-size: 0.9rem;
        "
      ></div>

      <form
        id="loginForm"
        style="display: flex; flex-direction: column; gap: 1rem;"
      >
        <input
          type="email"
          name="email"
          id="email"
          placeholder="Email address"
          required
          style="
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,180,80,0.3);
            padding: 0.8rem;
            color: #fff;
            border-radius: 8px;
            outline: none;
          "
        />
        <input
          type="password"
          name="password"
          id="password"
          placeholder="Password"
          required
          style="
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,180,80,0.3);
            padding: 0.8rem;
            color: #fff;
            border-radius: 8px;
            outline: none;
          "
        />
        <button
          type="submit"
          id="submitBtn"
          style="
            background: linear-gradient(90deg, #ff7b00, #ffb366);
            border: none;
            padding: 0.8rem;
            border-radius: 8px;
            color: #1b0f1f;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
          "
        >
          <span id="btnText">Enter</span>
          <span id="btnLoader" style="display: none;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
              <circle cx="12" cy="12" r="10" stroke-opacity="0.25"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke-opacity="0.75"/>
            </svg>
          </span>
        </button>
      </form>
    </div>
  </section>
</BaseLayout>

<style>
  button:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 0 15px rgba(255, 150, 50, 0.8);
  }
  
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  input:focus {
    border-color: #ffb366;
    box-shadow: 0 0 8px rgba(255, 180, 80, 0.6);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  const API_URL = "http://localhost:3000/auth/login";

  // Funci√≥n para decodificar el JWT
  function parseJwt(token: string) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(
        atob(base64)
          .split('')
          .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
          .join('')
      );
      return JSON.parse(jsonPayload);
    } catch (e) {
      console.error('Error parsing JWT:', e);
      return null;
    }
  }

  // Funci√≥n para mostrar errores
  function showError(message: string) {
    const errorDiv = document.getElementById("errorMessage");
    if (errorDiv) {
      errorDiv.textContent = message;
      errorDiv.style.display = "block";
    }
  }

  // Funci√≥n para ocultar errores
  function hideError() {
    const errorDiv = document.getElementById("errorMessage");
    if (errorDiv) {
      errorDiv.style.display = "none";
    }
  }

  // Funci√≥n para manejar el estado de carga
  function setLoading(loading: boolean) {
    const submitBtn = document.getElementById("submitBtn") as HTMLButtonElement;
    const btnText = document.getElementById("btnText");
    const btnLoader = document.getElementById("btnLoader");

    if (submitBtn) submitBtn.disabled = loading;
    if (btnText) btnText.style.display = loading ? "none" : "inline";
    if (btnLoader) btnLoader.style.display = loading ? "inline" : "none";
  }

  // Manejar el submit del formulario
  document.addEventListener("DOMContentLoaded", () => {
    const loginForm = document.getElementById("loginForm") as HTMLFormElement;

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideError();
      setLoading(true);

      const formData = new FormData(loginForm);
      const email = formData.get("email") as string;
      const password = formData.get("password") as string;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        const data = await res.json();

        // Manejo de errores espec√≠ficos
        if (!res.ok) {
          if (res.status === 401) {
            showError("‚ùå Invalid password. Please check and try again.");
          } else if (res.status === 404) {
            showError("‚ùå Email not found. Please verify your email or register.");
          } else if (res.status === 400) {
            showError("‚ùå Please provide both email and password.");
          } else {
            showError(data.message || "‚ùå Login failed. Please try again.");
          }
          setLoading(false);
          return;
        }

        // Login exitoso
        const token = data.token;

        if (!token) {
          showError("‚ùå Invalid response from server. Please try again.");
          setLoading(false);
          return;
        }

        // Decodificar el token para obtener la informaci√≥n del usuario
        const payload = parseJwt(token);

        if (!payload) {
          showError("‚ùå Invalid token format. Please contact support.");
          setLoading(false);
          return;
        }

        // Guardar informaci√≥n en localStorage
        localStorage.setItem("token", token);
        localStorage.setItem("userEmail", email);
        localStorage.setItem("userName", payload.name || "User");
        
        // Obtener el rol (el primer rol del array)
        const userRole = payload.roles && payload.roles.length > 0 
          ? payload.roles[0] 
          : "slave";
        
        localStorage.setItem("userRole", userRole);

        console.log("Login successful:", {
          name: payload.name,
          email: payload.email,
          role: userRole
        });

        // Redirigir seg√∫n el rol
        if (userRole === "slave") {
          // Si es slave, redirigir a la p√°gina de resistance
          window.location.href = "/resistance";
        } else {
          // Si es otro rol (admin, etc.), redirigir a admin
          window.location.href = "/admin";
        }

      } catch (error) {
        console.error("Login error:", error);
        showError("‚ùå Connection error. Please check your network and try again.");
        setLoading(false);
      }
    });
  });
</script>